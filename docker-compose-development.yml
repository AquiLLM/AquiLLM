
services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.prod

    restart: unless-stopped
    env_file:
      - .env
    environment:
      - C_FORCE_ROOT=1
    depends_on:
      db:
        condition: service_healthy
      createbuckets:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - .:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-8080}/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
  
  nginx:
      image: nginx:stable-bookworm
      restart: unless-stopped
      env_file:
        - .env
      ports:
        - "443:443"
        - "80:80"
      volumes:
        - ./deployment/nginx.conf:/etc/nginx/nginx.conf
        - ./deployment/aquillm.conf.template:/etc/nginx/templates/aquillm.conf.template
        - certs:/etc/letsencrypt
      healthcheck:
        test: ["CMD", "service", "nginx", "status"]
        interval: 30s
        timeout: 10s
        retries: 3
        start_period: 6s
      depends_on:
        web:
          condition: service_healthy
        get_certs:
          condition: service_completed_successfully

  get_certs:
    build:
      context: .
      dockerfile: Dockerfile.certbot
    ports:
      - "80:80"
    env_file:
      - .env
    volumes:
      - ./deployment/get_certs.sh:/get_certs.sh
      - certs:/etc/letsencrypt
      - ./deployment/get_certs.cron:/etc/cron.d/get_certs

  db:
    image: pgvector/pgvector:0.8.0-pg17
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  storage:
    image: minio/minio
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MINIO_ROOT_USER=dev
      - MINIO_ROOT_PASSWORD=rickbailey
      - MINIO_DEFAULT_BUCKETS=aquillm
    volumes:
      - minio_data:/data
    healthcheck:
      test: ['CMD', 'curl', '-f', '-I', 'localhost:9000/minio/health/live']
      interval: 5s
      timeout: 10s
      start_period: 15s
    command: minio server /data --console-address ":9001"

  redis:
    image: redis:7.4-bookworm
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
  createbuckets:
    image: minio/mc
    depends_on:
      storage:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set aquillm http://storage:9000 dev rickbailey;
      /usr/bin/mc mb aquillm/aquillm;
      exit 0;"
  
  ollama:
    build:
      context: .
      dockerfile: Dockerfile.ollama
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              driver: nvidia
    restart: unless-stopped
    profiles:
      - ollama
    volumes:
      - /media/volume/aquillmdev-vol/ollama:/root/.ollama
    env_file:
      - .env
    environment:
      - OLLAMA_KEEP_ALIVE=-1
    healthcheck:
      test: ["CMD-SHELL", "ollama --version && ollama ps || exit 1"]
      interval: 10s
      start_period: 10s

  vllm:
    container_name: vllm-qwen3_5
    image: vllm/vllm-openai:latest
    gpus: all
    ipc: host
    restart: unless-stopped
    profiles:
      - vllm
    env_file:
      - .env
    environment:
      - HF_TOKEN=${HF_TOKEN:-}
      - HUGGING_FACE_HUB_TOKEN=${HUGGING_FACE_HUB_TOKEN:-}
      - TORCH_CUDA_ARCH_LIST=8.0
      - PYTORCH_ALLOC_CONF=expandable_segments:True
      - VLLM_SLEEP_WHEN_IDLE=1
    ports:
      - "8000:8000"
    command: >
      unsloth/Qwen3.5-27B-GGUF
      --host 0.0.0.0
      --port 8000
      --served-model-name unsloth-qwen3.5-27b
      --gpu-memory-utilization 0.965
      --enable-prefix-caching
      --attention-backend FLASHINFER
    volumes:
      - ./root_cache:/root/.cache/
      - ./models:/models:ro
      - /dev/null:/etc/ld.so.conf.d/cuda-compat.conf
      - /dev/null:/etc/ld.so.conf.d/00-cuda-compat.conf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

volumes:
  postgres_data:
  minio_data:
  certs:
  ollama_data:
