{% extends "aquillm/base.html" %}

{% block title %}Conversation{% endblock %}

{% block content %}
<div id="error-container"></div>
<div id="conversation-container"></div>
<div id="form-container" class="bg-lighter-primary rounded-lg p-6">
<form id="message-form" action="{% url 'send_message' convo_id %}" method="post">
    {% csrf_token %}
    {{ form }}
    <input type="submit" value="Submit">
</form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function loadConversation() {
        fetch("{% url 'raw_convo' convo_id %}")
            .then(response => response.text())
            .then(data => {
                document.getElementById("conversation-container").innerHTML = data;
            });
    }
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById('message-form');
        const errorDiv = document.getElementById('error-container');
        loadConversation();
        document.getElementById("message-form").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadConversation();
                } else {
                    console.error('Error', data)
                    errorDiv.textContent = 'An error occurred. Please reload the page.';
                }
             })
            .catch(error => {
                console.error('Error:', error);
                errorDiv.textContent = 'An error occurred. Please reload the page or try again later.';
            })
            })
        });
</script>
{% endblock %}