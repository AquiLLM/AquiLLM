<div class="conversation">
    {% for message in conversation.messages.all %}
        <div class="message {% if message.sender == 'user' %}user-message{% else %}assistant-message{% endif %}">
            <p class="message-content">{{ message.content }}</p>
            <p class="message-timestamp">{{ message.timestamp|date:"Y-m-d H:i:s" }}</p>
            {% if message.context_chunks.exists %}
            <div class="context-chunks">
                <strong>Related Context:</strong>
                {% for chunk in message.context_chunks.all %}
                    <div class="context-chunk">
                        <details>
                            <summary class="chunk-title">{{ chunk.document.title|default:"Untitled Document" }} ({{ chunk.start_position }}-{{ chunk.end_position }})</summary>
                            <p class="chunk-content">{{ chunk.content }}</p>
                        </details>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        </div>
    {% endfor %}
</div>